# ğŸ—ï¸ Project Architecture

## Overview

This project consists of three main components deployed on Render:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER'S BROWSER                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   FRONTEND (React Static Site)          â”‚
        â”‚   URL: ccb-portal-static.onrender.com   â”‚
        â”‚                                          â”‚
        â”‚   - Serves HTML, CSS, JS                â”‚
        â”‚   - React Router for navigation          â”‚
        â”‚   - Uses REACT_APP_API_URL env var      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ API Calls
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   BACKEND (Django/Python)                â”‚
        â”‚   URL: ccb-portal-backend.onrender.com   â”‚
        â”‚                                          â”‚
        â”‚   - REST API endpoints (/api/*)          â”‚
        â”‚   - Serves media files (/media/*)        â”‚
        â”‚   - Django Admin (/admin/)               â”‚
        â”‚   - Authentication & CRUD                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   POSTGRESQL DB   â”‚  â”‚   MEDIA DISK   â”‚
        â”‚                   â”‚  â”‚   1GB Storage  â”‚
        â”‚   - User data     â”‚  â”‚   - Images     â”‚
        â”‚   - Content       â”‚  â”‚   - Files      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Details

### 1. Frontend (React Static Site)

**Technology**: React 18, React Router
**Hosting**: Render Static Site
**Purpose**: User interface

#### Key Files:
- `src/App.js` - Main application component
- `src/news_events.js` - News & Events page (uses images)
- `src/services/api.js` - API client
- `src/utils/imageUtils.js` - Image URL normalization

#### How Images Work:
1. Frontend fetches data from backend API
2. API returns image URLs (e.g., `/media/announcements/image.jpg`)
3. `normalizeImageUrl()` converts to absolute URL using `REACT_APP_API_URL`
4. Result: `https://backend.onrender.com/media/announcements/image.jpg`

#### Environment Variables:
```bash
REACT_APP_API_URL=https://ccb-portal-backend.onrender.com
```

---

### 2. Backend (Django/Python)

**Technology**: Django 5.2, Python 3.11
**Hosting**: Render Web Service
**Purpose**: API, data management, file serving

#### Key Files:
- `ccb_portal_backend/settings.py` - Development config
- `ccb_portal_backend/production_settings.py` - Production overrides
- `portal/views.py` - API endpoints
- `portal/models.py` - Data models
- `portal/utils.py` - Helper functions
- `manage.py` - Django management

#### API Endpoints:
```
/api/test/                    - Health check
/api/announcements/           - Get announcements (with images)
/api/events/                  - Get events (with images)
/api/news/                    - Get news (with images)
/api/achievements/            - Get achievements (with images)
/api/academic-programs/       - Get programs
/api/admissions-info/         - Get admissions data
/api/contact-form/            - Submit contact form
/admin/                       - Django admin panel
/media/*                      - Media files (images)
```

#### Environment Variables:
```bash
DJANGO_SETTINGS_MODULE=ccb_portal_backend.production_settings
SECRET_KEY=<auto-generated>
DATABASE_URL=<auto-populated>
ALLOWED_HOSTS=ccb-portal-backend.onrender.com,ccb-portal-frontend.onrender.com
CORS_ALLOWED_ORIGINS=https://ccb-portal-frontend.onrender.com,https://ccb-portal-static.onrender.com
BREVO_API_KEY=<your-key>
OPENAI_API_KEY=<your-key>
```

---

### 3. Database (PostgreSQL)

**Technology**: PostgreSQL
**Hosting**: Render Managed Database
**Purpose**: Data storage

#### Tables:
- `portal_announcement` - Announcements with images
- `portal_event` - Events with images
- `portal_news` - News articles with images
- `portal_achievement` - Achievements with images
- `portal_academicprogram` - Academic programs
- `portal_contactsubmission` - Contact form submissions
- `auth_user` - Admin users
- (and more)

---

### 4. Media Storage (Disk)

**Technology**: Persistent Disk (1GB)
**Mount Path**: `/opt/render/project/src/media`
**Purpose**: Store uploaded images and files

#### Structure:
```
media/
â”œâ”€â”€ announcements/
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â””â”€â”€ image2.png
â”œâ”€â”€ events/
â”‚   â”œâ”€â”€ event1.jpg
â”‚   â””â”€â”€ event2.png
â”œâ”€â”€ news/
â”‚   â”œâ”€â”€ news1.jpg
â”‚   â””â”€â”€ news2.jpg
â”œâ”€â”€ achievements/
â”‚   â”œâ”€â”€ achievement1.jpg
â”‚   â””â”€â”€ achievement2.png
â””â”€â”€ downloads/
    â”œâ”€â”€ form.pdf
    â””â”€â”€ document.docx
```

---

## Data Flow

### Example: Loading News & Events Page

```
1. User visits /news
   â””â”€> Browser loads React app from Frontend Static Site

2. React app needs data
   â””â”€> Calls API: GET ${REACT_APP_API_URL}/api/announcements/

3. Backend receives request
   â””â”€> Django views.py: api_announcements()
   â””â”€> Queries database
   â””â”€> Returns JSON with image URLs

4. Frontend receives response:
   {
     "announcements": [
       {
         "id": 1,
         "title": "Welcome",
         "image": "https://backend.onrender.com/media/announcements/welcome.jpg"
       }
     ]
   }

5. React renders the data
   â””â”€> normalizeImageUrl() ensures correct URL
   â””â”€> Browser requests image from backend
   â””â”€> Backend serves from /media/ directory

6. Image displays! âœ…
```

---

## Security Features

### Backend:
- âœ… HTTPS enforced (SECURE_SSL_REDIRECT)
- âœ… CORS configured for frontend domain
- âœ… CSRF protection enabled
- âœ… SQL injection prevention (Django ORM)
- âœ… XSS protection (input sanitization)
- âœ… Rate limiting on contact form
- âœ… Email verification for submissions
- âœ… Secure session cookies
- âœ… HSTS headers

### Frontend:
- âœ… HTTPS enforced
- âœ… API calls use credentials
- âœ… No sensitive data in client-side code
- âœ… React's built-in XSS protection

---

## Development vs Production

### Development (Local):
```
Frontend:  http://localhost:3000
Backend:   http://127.0.0.1:8000
Database:  MySQL (XAMPP)
CORS:      Allow all origins
DEBUG:     True
```

### Production (Render):
```
Frontend:  https://ccb-portal-static.onrender.com
Backend:   https://ccb-portal-backend.onrender.com
Database:  PostgreSQL (Render)
CORS:      Specific origins only
DEBUG:     False
```

---

## Why Images Weren't Working

### The Problem:
```
âŒ Frontend didn't know where backend was
âŒ REACT_APP_API_URL was not set
âŒ Images tried to load from: /media/... (relative URL)
âŒ Browser looked on frontend server (static site has no /media/)
âŒ Result: 404 errors, no images
```

### The Solution:
```
âœ… Set REACT_APP_API_URL on frontend service
âœ… Frontend now knows backend URL
âœ… normalizeImageUrl() converts: /media/... 
   â†’ https://backend.onrender.com/media/...
âœ… Browser requests from correct server
âœ… Backend serves image from disk
âœ… Result: Images display! ğŸ‰
```

---

## File Upload Flow

### When Admin Uploads an Image:

```
1. Admin logs into /admin/
2. Creates announcement with image
3. Django saves:
   - Data to database
   - Image to disk: /opt/render/project/src/media/announcements/
4. Database stores relative path: announcements/image.jpg

5. When user visits /news:
   - API query fetches announcement from database
   - build_safe_media_url() converts relative path to absolute URL
   - Returns: https://backend.onrender.com/media/announcements/image.jpg
   
6. Frontend receives absolute URL
   - normalizeImageUrl() checks if URL is already absolute
   - If yes, returns as-is
   - If no, prepends REACT_APP_API_URL
   
7. Browser requests image from backend
8. Django serves file from disk
9. Image displays on page âœ…
```

---

## Scaling Considerations

### Current Setup (Free Tier):
- Backend: 512MB RAM, spins down after 15 min inactivity
- Frontend: Static files on CDN
- Database: 256MB storage, 90 days retention
- Disk: 1GB, persistent across deploys

### For Heavy Traffic:
- Upgrade to paid Render tier (no cold starts)
- Use external storage (AWS S3, Cloudinary) for media
- Add Redis for caching
- Enable database connection pooling
- Optimize images (compression, CDN)
- Add load balancing for multiple backend instances

---

## Monitoring

### Health Checks:
```bash
# Backend health
curl https://backend.onrender.com/api/test/

# API data
curl https://backend.onrender.com/api/announcements/

# Media file
curl https://backend.onrender.com/media/announcements/some-image.jpg
```

### Logs:
- Render Dashboard â†’ Service â†’ Logs
- Check for errors on deploy or during requests
- Monitor disk usage (free tier has 1GB limit)

---

## Quick Reference

### Update Backend Code:
```bash
git add .
git commit -m "Update backend"
git push origin main
# Render auto-deploys from main branch
```

### Update Frontend Code:
```bash
git add .
git commit -m "Update frontend"
git push origin main
# Render auto-deploys and rebuilds static files
```

### Add/Change Environment Variable:
1. Render Dashboard â†’ Service â†’ Environment
2. Add/Edit variable
3. Save
4. **Frontend**: Must manually redeploy!
5. **Backend**: Auto-redeploys

### Upload Images:
1. Go to backend admin: `/admin/`
2. Navigate to Announcements/Events/News/Achievements
3. Create or edit item
4. Upload image
5. Save
6. Image immediately available via API

---

## Troubleshooting Quick Reference

| Issue | Cause | Solution |
|-------|-------|----------|
| Images not loading | REACT_APP_API_URL not set | Set env var and redeploy frontend |
| CORS errors | Wrong CORS_ALLOWED_ORIGINS | Update backend env var |
| 404 on images | Image doesn't exist | Upload via Django admin |
| API calls fail | Backend down or wrong URL | Check backend URL and status |
| Backend errors | Missing env var or dependency | Check logs and environment vars |
| Build fails | Syntax error or missing file | Check logs for error details |
| Cold start slow | Free tier limitation | Upgrade or use uptime monitor |
| Disk full | Too many large files | Delete old files or upgrade disk |

